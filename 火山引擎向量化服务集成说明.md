# 火山引擎向量化服务集成说明

## 功能概述

已成功集成火山引擎向量化服务（Volcengine Embeddings API），用于视频摘要的向量化存储和语义检索。

## 主要特性

1. **多后端支持**
   - ChromaDB（本地向量存储）
   - 火山引擎向量化服务（云端向量化）

2. **核心功能**
   - 视频摘要向量化存储
   - 段落级别的语义检索
   - 基于相似度的智能问答

3. **配置界面**
   - 在"智能摘要配置"对话框中新增向量化服务配置
   - 支持切换不同的向量存储后端
   - 提供连接测试功能

## 文件结构

### 新增文件

1. **videotrans/hearsight/volcengine_vector.py**
   - 火山引擎向量化服务客户端
   - 实现文档向量化、存储和检索功能
   - 混合架构：向量化使用云端API，数据存储在本地JSON

### 修改文件

1. **videotrans/hearsight/vector_store.py**
   - 添加多后端支持
   - `get_vector_store()` 函数根据配置自动选择后端
   - 新增 `reset_vector_store()` 用于切换后端

2. **videotrans/ui/hearsight_config.py**
   - 添加向量化服务配置UI组件
   - 支持配置火山引擎API参数
   - 增强测试连接功能

## 配置说明

### 打开配置界面

1. 启动程序
2. 点击主界面的 "智能摘要配置" 按钮（或相应菜单项）
3. 在配置对话框中找到 "向量化服务配置" 部分

### 配置火山引擎向量化服务

1. **选择向量存储类型**
   - 下拉选择 "火山引擎向量化服务"

2. **填写必要参数**：

   - **API Key**: `2cad3d85-a6a5-433e-9ac5-41598e1aae83`
   - **Base URL**: `https://ark.cn-beijing.volces.com/api/v3`
   - **Collection名称**: `video_summaries` (默认)
   - **Embedding模型**: 输入您的endpoint ID（如 `ep-20241217191853-w54rf`）

3. **测试连接**
   - 点击 "测试连接" 按钮
   - 系统会同时测试LLM和向量化服务连接
   - 显示测试结果

4. **保存配置**
   - 点击 "保存配置" 按钮
   - 配置会保存到 `hearsight_config.json` 文件

## API参数说明

### 火山引擎Embeddings API

- **Endpoint**: `{base_url}/embeddings`
- **认证方式**: Bearer Token (API Key)
- **请求格式**:
  ```json
  {
    "model": "ep-xxxxxxxx",
    "input": "文本内容" | ["文本1", "文本2"],
    "encoding_format": "float"
  }
  ```
- **响应格式**:
  ```json
  {
    "data": [
      {
        "index": 0,
        "embedding": [0.1, 0.2, ...]
      }
    ]
  }
  ```

## 使用流程

### 1. 存储视频摘要

当视频翻译完成且启用"智能摘要"功能时：

1. 系统自动调用LLM生成摘要
2. 将摘要文本发送到火山引擎向量化API
3. 获取embedding向量
4. 存储到本地JSON文件（包含向量和元数据）

**存储位置**: `{项目根目录}/vector_db/volcengine/{video_id}.json`

### 2. 语义检索

用户查询视频内容时：

1. 对查询文本进行向量化
2. 计算与所有存储文档的余弦相似度
3. 返回最相关的N个结果
4. 结果包含：文档内容、元数据、相似度分数

### 3. 代码示例

```python
from videotrans.hearsight.vector_store import get_vector_store

# 获取向量存储实例（自动根据配置选择后端）
vector_store = get_vector_store()

# 存储摘要
success = vector_store.store_summary(
    video_path="/path/to/video.mp4",
    summary={
        "topic": "视频主题",
        "summary": "视频总结",
        "total_duration": 120.5
    },
    paragraphs=[
        {
            "text": "段落内容",
            "summary": "段落摘要",
            "start_time": 0.0,
            "end_time": 10.0
        }
    ]
)

# 语义搜索
results = vector_store.search(
    query="用户的问题",
    n_results=5
)

for result in results:
    print(f"文档: {result['document']}")
    print(f"相似度: {result['similarity']}")
    print(f"元数据: {result['metadata']}")
```

## 技术架构

### 混合存储方案

由于火山引擎向量化服务主要提供Embedding API，我们采用混合架构：

1. **向量化**: 使用火山引擎云端API
   - 调用 `/embeddings` endpoint
   - 获取高质量的文本向量表示

2. **存储**: 本地JSON文件
   - 存储完整的文档内容
   - 存储向量数据
   - 存储元数据（视频信息、时间戳等）

3. **检索**: 本地计算
   - 加载所有向量
   - 计算余弦相似度
   - 返回TopK结果

### 优势

- ✅ 利用火山引擎高质量的Embedding模型
- ✅ 数据完全本地化，保护隐私
- ✅ 无需管理复杂的向量数据库服务
- ✅ 可离线查询（embedding后）

## 注意事项

1. **API密钥安全**
   - API密钥会以密码形式显示（不可见）
   - 配置文件保存在本地，请注意保护

2. **向量维度**
   - 火山引擎Embedding模型输出维度通常为768或1024
   - 具体维度取决于您选择的模型

3. **存储空间**
   - 每个视频的向量数据约占用几MB空间
   - 建议定期清理不需要的向量数据

4. **性能考虑**
   - 批量向量化时建议使用批处理API
   - 本地搜索性能与存储的文档数量成正比
   - 对于大规模应用，建议考虑专业的向量数据库

## 故障排查

### 连接测试失败

1. 检查API Key是否正确
2. 确认Base URL是否可访问
3. 验证Embedding模型endpoint ID是否有效
4. 检查网络连接

### 向量化失败

1. 查看日志输出的错误信息
2. 确认文本长度不超过模型限制
3. 检查API配额是否充足

### 搜索无结果

1. 确认已有向量数据存储
2. 检查 `vector_db/volcengine/` 目录下是否有JSON文件
3. 尝试不同的查询关键词

## 后续扩展

可考虑的功能增强：

1. 支持更多向量化服务提供商
2. 实现向量数据的定期同步和备份
3. 添加向量索引优化（如FAISS）
4. 支持多语言向量化
5. 实现混合检索（向量+关键词）

## 技术支持

- 火山引擎文档: https://www.volcengine.com/docs/82379/1521766
- 项目Issue: 请在GitHub仓库提交问题
