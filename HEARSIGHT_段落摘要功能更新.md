# HearSight 段落摘要功能更新

## 📋 更新概述

参考 HearSight 原项目的设计理念,为 pyvideotrans 集成的 HearSight 功能添加了**段落级摘要**功能。现在每个段落都会生成一个简洁的摘要（不超过50字），便于快速了解段落核心内容。

更新日期：2025-10-01

---

## ✨ 新功能

### 1. 段落级摘要生成

- **自动生成**：处理 SRT 文件时,自动为每个合并后的段落生成摘要
- **简洁准确**：每个段落摘要不超过 50 字,提炼核心要点
- **智能提示词**：使用优化的提示词确保摘要质量
- **容错处理**：如果某个段落摘要生成失败,自动使用原文前 50 字作为备用

### 2. UI 显示增强

#### 段落列表
- 有摘要的段落：显示 `💡` 图标 + 摘要预览（40字）
- 无摘要的段落：显示原文预览（30字）

#### 段落详情
- **时间标签**：蓝色渐变背景,显示时间范围
- **摘要卡片**：黄色渐变背景,突出显示段落摘要
- **原文内容**：完整的段落文本

### 3. Markdown 导出

导出的 Markdown 文件包含：
- 整体摘要（主题 + 总结）
- 统计信息（段落数、总时长）
- 每个段落的：
  - 时间范围标题
  - **段落摘要**（如果存在）
  - 完整原文

---

## 🔧 技术实现

### 修改的文件

#### 1. `videotrans/hearsight/processor.py`

**修改内容**：
- 添加步骤4：为每个段落生成摘要
- 调用 `generate_paragraph_summaries()` 函数
- 更新进度提示（70% → 75% → 100%）

**代码变更**：
```python
# 步骤3：生成整体摘要
self.progress_updated.emit("正在生成整体摘要...", 60)
summary = generate_summary(...)

# 步骤4：为每个段落生成摘要（新增）
self.progress_updated.emit(f"正在为每个段落生成摘要（共{len(paragraphs)}个）...", 75)
paragraphs_with_summaries = generate_paragraph_summaries(...)

# 返回带摘要的段落列表
self.finished.emit(summary, paragraphs_with_summaries)
```

#### 2. `videotrans/ui/hearsight_viewer.py`

**修改内容**：

**段落列表显示**：
```python
# 优先显示摘要预览
if summary:
    preview = summary[:40] + "..." if len(summary) > 40 else summary
    item_text = f"[{start_str}-{end_str}] 💡 {preview}"
else:
    preview = text[:30] + "..." if len(text) > 30 else text
    item_text = f"[{start_str}-{end_str}] {preview}"
```

**段落详情显示**：
```python
# 添加摘要卡片（黄色渐变背景）
{f'''<div style="background: linear-gradient(135deg, #fff9e6 0%, #fff3d9 100%);
            padding: 14px 18px;
            border-radius: 8px;
            margin-bottom: 18px;
            border-left: 4px solid #ffb833;">
    <div style="color: #856404; font-weight: bold; font-size: 14px;">
        💡 段落摘要
    </div>
    <div style="color: #664d03; font-size: 13px; line-height: 1.7;">
        {para_summary}
    </div>
</div>''' if para_summary else ''}
```

#### 3. `videotrans/hearsight/summarizer.py`

**已有功能**（无需修改）：
- `generate_paragraph_summaries()` 函数已实现
- `export_summary_to_markdown()` 已支持段落摘要导出

---

## 🎨 UI 设计特点

### 配色方案

1. **时间标签**
   - 背景：蓝色渐变 `#e8f4f8 → #d6e9f5`
   - 左边框：`#4a9eff`（5px）
   - 文字：`#2c5aa0`（深蓝）

2. **摘要卡片**
   - 背景：黄色渐变 `#fff9e6 → #fff3d9`
   - 左边框：`#ffb833`（4px）
   - 标题：`#856404`（深黄）
   - 内容：`#664d03`（棕黄）

3. **原文内容**
   - 文字：`#34495e`（深灰蓝）
   - 行高：2.0（舒适阅读）

### 视觉层次

```
┌─────────────────────────────────────┐
│ ⏱ 时间段: 00:00 - 00:30          │ ← 蓝色卡片
├─────────────────────────────────────┤
│ 💡 段落摘要                       │
│ 这是一个简短的段落摘要...         │ ← 黄色卡片（可选）
├─────────────────────────────────────┤
│ 完整的段落文本内容...             │ ← 白色背景
│ 可能有多行...                     │
└─────────────────────────────────────┘
```

---

## 📈 处理流程

```
1. 用户点击"智能摘要"按钮
   ↓
2. 选择 SRT 文件
   ↓
3. [10%] 检查文件
   ↓
4. [20%] 合并段落（规则基础）
   ↓
5. [60%] 生成整体摘要（1次 LLM 调用）
   ↓
6. [75%] 为每个段落生成摘要（N次 LLM 调用）
   │   ├─ 段落1 → "核心要点1"
   │   ├─ 段落2 → "核心要点2"
   │   └─ ...
   ↓
7. [100%] 显示结果
   ↓
8. 用户可以：
   - 点击段落查看详情（含摘要）
   - 导出 Markdown（含段落摘要）
```

---

## ⚙️ 配置说明

### 段落摘要生成参数

在配置对话框中设置：

| 参数 | 默认值 | 说明 |
|------|--------|------|
| API Key | 必填 | OpenAI 兼容 API 密钥 |
| Base URL | `https://api.openai.com/v1` | API 地址 |
| Model | `gpt-3.5-turbo` | 使用的模型 |
| Temperature | 0.3 | 温度参数（建议 0.3-0.5） |
| Timeout | 60秒 | 单个段落摘要超时时间 |

### 提示词策略

```
请用一句话（不超过50字）总结以下内容的核心要点：

{段落文本}

只输出总结内容，不要有任何前缀或后缀。
```

**特点**：
- ✅ 简洁明确的指令
- ✅ 限制字数（50字）
- ✅ 要求直接输出（无格式）
- ✅ 专注核心要点

---

## 💡 使用建议

### 1. 模型选择

**推荐模型**：
- `gpt-3.5-turbo`：速度快，成本低（推荐）
- `gpt-4`：质量更高，速度较慢
- `deepseek-chat`：国内模型，性价比高
- `gemini-pro`：Google 模型

### 2. 成本估算

假设使用 `gpt-3.5-turbo`：
- 整体摘要：~1000 tokens ≈ $0.002
- 段落摘要（每个）：~150 tokens ≈ $0.0003
- **总成本**（10分钟视频，15个段落）：
  - 整体摘要：$0.002
  - 段落摘要：$0.0003 × 15 = $0.0045
  - **合计**：~$0.007（约 5 分钱）

### 3. 处理时间

- 10分钟视频（15个段落）：
  - 段落合并：<5秒
  - 整体摘要：10-30秒
  - 段落摘要：15-45秒（并发）
  - **总计**：约 1-2 分钟

### 4. 优化建议

**减少成本**：
- 使用 `gpt-3.5-turbo` 而非 `gpt-4`
- 考虑使用国产模型（DeepSeek、通义千问等）

**提高速度**：
- 增加 timeout 参数
- 使用响应更快的 API 服务商
- 考虑本地 LLM（如 Ollama）

**提升质量**：
- 使用 `gpt-4` 或 `claude-3-sonnet`
- 调整 temperature（0.3-0.5）
- 优化提示词

---

## 🔍 示例效果

### 段落列表显示

```
[00:00-00:30] 💡 介绍了项目的背景和目标，以及开发动机...
[00:30-01:00] 💡 详细说明了技术栈的选择，包括 Python 和...
[01:00-01:30] 💡 演示了核心功能的使用流程，从输入到输出...
```

### 段落详情显示

```
╔═══════════════════════════════════════════╗
║ ⏱ 时间段: 00:00 - 00:30                  ║
╠═══════════════════════════════════════════╣
║ 💡 段落摘要                              ║
║ 介绍了项目的背景和目标，以及开发动机    ║
╠═══════════════════════════════════════════╣
║ 大家好，今天我要给大家介绍一个新项目。  ║
║ 这个项目的目标是...（完整原文）          ║
╚═══════════════════════════════════════════╝
```

### Markdown 导出示例

```markdown
# 视频内容摘要

## 总结

本视频介绍了一个基于AI的视频处理项目...

**段落数**: 15 | **总时长**: 10:25

---

## 详细内容

### [00:00 - 00:30]

**摘要**: 介绍了项目的背景和目标，以及开发动机

大家好，今天我要给大家介绍一个新项目。
这个项目的目标是...（完整原文）

### [00:30 - 01:00]

**摘要**: 详细说明了技术栈的选择，包括 Python 和 PySide6

在技术选型上，我们选择了...（完整原文）
```

---

## 🐛 错误处理

### 段落摘要生成失败

**情况**：
- API 超时
- 网络错误
- 配额耗尽

**处理**：
```python
try:
    summary_text = chat_with_openai(...)
    para_copy["summary"] = summary_text.strip()
except Exception as e:
    # 使用原文前50字作为摘要
    para_copy["summary"] = para["text"][:50] + "..."
    para_copy["summary_error"] = str(e)
```

**结果**：
- 不会中断整个处理流程
- 失败的段落显示原文预览
- 错误信息存储在 `summary_error` 字段

---

## 🎯 与 HearSight 原项目的一致性

### 相同点

1. **段落级摘要**：每个段落都有独立摘要
2. **简洁原则**：摘要控制在 50 字以内
3. **视觉区分**：摘要与原文明确区分（不同背景色）
4. **导出支持**：Markdown 导出包含段落摘要

### 差异点

| 特性 | HearSight 原项目 | pyvideotrans 集成 |
|------|------------------|-------------------|
| ASR 引擎 | FunASR | Whisper (SRT) |
| 段落划分 | LLM 辅助 | 规则基础 |
| UI 框架 | React + Ant Design | PySide6 + Qt |
| 部署方式 | Web 应用（FastAPI） | 桌面应用 |

### 设计理念继承

✅ **快速获取要点**：通过段落摘要快速了解内容
✅ **时间定位**：点击段落可跳转到对应时间
✅ **层次化展示**：整体摘要 → 段落摘要 → 完整文本
✅ **易于导出**：支持 Markdown 格式导出

---

## 📝 下一步优化方向

### 可能的改进

1. **并发生成**
   - 当前：顺序调用 LLM（段落1 → 段落2 → ...）
   - 优化：使用线程池并发调用（更快）

2. **缓存机制**
   - 为相同段落内容缓存摘要
   - 避免重复调用 LLM

3. **自定义提示词**
   - 允许用户自定义段落摘要的提示词模板
   - 适配不同类型的内容（技术、生活、教育等）

4. **摘要质量评估**
   - 显示摘要的置信度
   - 提供"重新生成"按钮

5. **多语言支持**
   - 支持英文、日文等语言的摘要
   - 自动检测原文语言

---

## 🎉 总结

通过添加段落级摘要功能，HearSight 集成到 pyvideotrans 的功能更加完善：

✅ **三级摘要体系**：
1. 整体摘要（视频级）
2. 段落摘要（段落级）
3. 完整原文（句子级）

✅ **优雅的 UI 设计**：
- 现代化配色
- 清晰的视觉层次
- 良好的用户体验

✅ **完整的导出功能**：
- Markdown 格式
- 包含所有摘要信息
- 便于分享和存档

✅ **参考 HearSight 设计**：
- 保持一致的设计理念
- 适配桌面应用场景
- 优化用户体验

---

**开发完成时间**：2025-10-01
**版本**：v1.1（段落摘要增强版）
