# 视频播放调试指南

## 🐛 问题修复记录

### 问题1: 没有使用翻译后的视频

**症状**: 点击时间链接后，播放的是原始视频而不是翻译后的视频

**原因**: `find_target_video()`逻辑正确，但缺少调试信息，无法确认是否找到目标视频

**修复方案**: 添加详细的调试日志

**调试输出示例**:
```
🔍 开始查找目标视频...
   原始路径: F:\videos\test.mp4
   目录: F:\videos
   文件名: test
   扩展名: .mp4
   查找目标视频...
   [1] 检查: test_target.mp4
   ✅ 找到目标视频: F:\videos\test_target.mp4
```

**如果找不到目标视频**:
```
🔍 开始查找目标视频...
   原始路径: F:\videos\test.mp4
   目录: F:\videos
   文件名: test
   扩展名: .mp4
   查找目标视频...
   [1] 检查: test_target.mp4
       不存在
   [2] 检查: test-target.mp4
       不存在
   [3] 检查: test.target.mp4
       不存在
   [4] 检查: test_translated.mp4
       不存在
   [5] 检查: test-translated.mp4
       不存在
   ⚠️ 未找到目标视频，使用原始视频: F:\videos\test.mp4
```

### 问题2: 没有跳转到对应的时间点位置

**症状**: 视频从头开始播放，没有跳转到指定的时间点

**原因**: 
1. 时间跳转在`on_duration_changed`中执行
2. 该事件可能在视频完全加载前触发
3. 此时`setPosition()`可能不生效

**修复方案**:
1. 添加`has_seeked`标志，防止重复跳转
2. 监听`mediaStatusChanged`信号
3. 在`LoadedMedia`状态时执行跳转
4. 添加详细的状态日志

**调试输出示例**:
```
🎬 初始化视频播放器...
   视频路径: F:\videos\test_target.mp4
   开始时间: 19.064秒

📂 加载视频文件: F:\videos\test_target.mp4
✅ 视频加载命令已发送

📡 媒体状态: 加载中
📡 媒体状态: 已加载
⏩ [LoadedMedia] 跳转到: 19064ms (19.064秒)
▶️ [LoadedMedia] 开始播放...

⏱️ 视频时长: 300000ms (300.00秒)
🎵 播放状态: 播放中
```

## 📊 调试日志说明

### 视频查找日志

| 图标 | 含义 |
|------|------|
| 🔍 | 开始查找目标视频 |
| ✅ | 找到目标视频 |
| ⚠️ | 未找到目标视频，使用原始视频 |

### 播放器状态日志

| 图标 | 含义 |
|------|------|
| 🎬 | 初始化播放器 |
| 📂 | 加载视频文件 |
| 📡 | 媒体状态改变 |
| ⏱️ | 视频时长信息 |
| ⏩ | 跳转到指定时间 |
| ▶️ | 开始播放 |
| 🎵 | 播放状态改变 |
| ❌ | 错误信息 |

### 媒体状态说明

| 状态 | 说明 |
|------|------|
| **无媒体** | 没有加载任何媒体 |
| **加载中** | 正在加载媒体文件 |
| **已加载** | 媒体文件已加载完成 ✅ |
| **停滞** | 媒体加载停滞 |
| **缓冲中** | 正在缓冲数据 |
| **已缓冲** | 缓冲完成 |
| **播放结束** | 媒体播放到结尾 |
| **无效媒体** | 媒体文件无效或损坏 |

### 播放状态说明

| 状态 | 说明 |
|------|------|
| **停止** | 播放器已停止 |
| **播放中** | 正在播放 ✅ |
| **暂停** | 播放已暂停 |

## 🔧 调试步骤

### 1. 检查目标视频是否存在

**操作**: 点击时间链接

**查看日志**:
```
🔍 开始查找目标视频...
   原始路径: /path/to/video.mp4
   ...
```

**检查项**:
- [ ] 原始路径是否正确？
- [ ] 目录路径是否存在？
- [ ] 是否找到目标视频？
- [ ] 目标视频文件名是否符合命名规则？

**常见问题**:

**Q1: 原始路径不正确**
```
原始路径: /path/to/nonexistent.mp4
⚠️ 原始视频不存在！
```
**解决**: 检查数据库中存储的video_path是否正确

**Q2: 目标视频命名不符合规则**
```
实际文件: video_final.mp4
查找文件: video_target.mp4, video-target.mp4, ...
```
**解决**: 重命名为`video_target.mp4`或修改查找规则

### 2. 检查视频加载状态

**查看日志**:
```
📂 加载视频文件: /path/to/video_target.mp4
✅ 视频加载命令已发送
📡 媒体状态: 加载中
📡 媒体状态: 已加载
```

**检查项**:
- [ ] 视频文件路径是否正确？
- [ ] 媒体状态是否变为"已加载"？
- [ ] 是否出现"无效媒体"状态？

**常见问题**:

**Q1: 媒体状态一直是"加载中"**
```
📡 媒体状态: 加载中
(长时间没有变化)
```
**可能原因**:
- 视频文件损坏
- 视频格式不支持
- 文件路径错误

**Q2: 媒体状态变为"无效媒体"**
```
📡 媒体状态: 无效媒体
```
**可能原因**:
- 视频编码不支持
- 缺少必要的编解码器
- 文件损坏

**解决方法**:
```bash
# 使用ffmpeg转换为标准格式
ffmpeg -i input.mp4 -c:v libx264 -c:a aac output.mp4
```

### 3. 检查时间跳转

**查看日志**:
```
⏩ [LoadedMedia] 跳转到: 19064ms (19.064秒)
▶️ [LoadedMedia] 开始播放...
⏱️ 视频时长: 300000ms (300.00秒)
🎵 播放状态: 播放中
```

**检查项**:
- [ ] 是否看到"跳转到"日志？
- [ ] 跳转时间是否正确？
- [ ] 播放状态是否变为"播放中"？

**常见问题**:

**Q1: 没有看到"跳转到"日志**
```
📡 媒体状态: 已加载
⏱️ 视频时长: 300000ms (300.00秒)
(没有跳转日志)
```
**可能原因**:
- `start_time`为0
- `has_seeked`标志已经设置

**Q2: 跳转时间不正确**
```
⏩ 跳转到: 0ms (0.0秒)
(应该是19064ms)
```
**可能原因**:
- 传入的`start_time`参数错误
- 时间格式转换错误

### 4. 完整的正常日志示例

```
▶️ 准备播放视频...
   视频路径: F:\videos\test.mp4
   开始时间: 19.064秒

🔍 开始查找目标视频...
   原始路径: F:\videos\test.mp4
   目录: F:\videos
   文件名: test
   扩展名: .mp4
   查找目标视频...
   [1] 检查: test_target.mp4
   ✅ 找到目标视频: F:\videos\test_target.mp4

🎬 打开播放器...
   最终视频: F:\videos\test_target.mp4
   跳转时间: 19.064秒

🎬 初始化视频播放器...
   视频路径: F:\videos\test_target.mp4
   开始时间: 19.064秒

📂 加载视频文件: F:\videos\test_target.mp4
✅ 视频加载命令已发送

📡 媒体状态: 加载中
📡 媒体状态: 已加载
⏩ [LoadedMedia] 跳转到: 19064ms (19.064秒)
▶️ [LoadedMedia] 开始播放...

⏱️ 视频时长: 300000ms (300.00秒)
🎵 播放状态: 播放中
```

## 🛠️ 故障排除

### 问题: 视频不播放

**检查清单**:
1. 查看控制台日志，确认媒体状态
2. 检查视频文件是否存在且可访问
3. 尝试用其他播放器打开视频文件
4. 检查视频格式是否支持

**推荐格式**: MP4 (H.264 + AAC)

### 问题: 时间跳转不生效

**检查清单**:
1. 确认看到"跳转到"日志
2. 检查跳转时间是否正确
3. 确认媒体状态为"已加载"
4. 检查`has_seeked`标志

### 问题: 找不到目标视频

**检查清单**:
1. 确认目标视频与原始视频在同一目录
2. 检查文件名是否符合命名规则
3. 查看调试日志中的查找过程
4. 手动重命名文件为`原名_target.扩展名`

## 📝 最佳实践

### 1. 视频文件命名

**推荐命名**:
```
原始视频: video.mp4
翻译视频: video_target.mp4  ← 推荐
```

**其他支持的命名**:
```
video-target.mp4
video.target.mp4
video_translated.mp4
video-translated.mp4
```

### 2. 视频格式选择

**推荐格式**: MP4 (H.264)

**转换命令**:
```bash
ffmpeg -i input.avi -c:v libx264 -c:a aac -strict experimental output.mp4
```

### 3. 目录结构

```
project/
├── video.mp4           # 原始视频
├── video_target.mp4    # 翻译视频
├── video.srt           # 字幕文件
└── ...
```

## 🔍 如何查看调试日志

### Windows

1. 从命令行启动程序：
```cmd
cd F:\智能体定制\20250904translateVideo\pyvideotrans
python videotrans\__main__.py
```

2. 或者查看日志文件（如果有配置）

### macOS/Linux

1. 从终端启动程序：
```bash
cd /path/to/pyvideotrans
python videotrans/__main__.py
```

2. 日志会输出到终端

## 📞 获取帮助

如果问题仍然存在：

1. **收集信息**:
   - 完整的控制台日志
   - 视频文件信息（格式、大小、编码）
   - 操作系统和Python版本
   - 错误截图

2. **检查文档**:
   - [内嵌视频播放器使用说明.md](./内嵌视频播放器使用说明.md)
   - [视频时间跳转功能说明.md](./视频时间跳转功能说明.md)

3. **提交Issue**:
   - 包含上述收集的信息
   - 描述复现步骤
   - 附上日志和截图

