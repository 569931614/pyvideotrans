# 内嵌视频播放器使用说明

## 📺 功能概述

新版本实现了内嵌视频播放器，无需安装外部播放器（VLC/PotPlayer/IINA），直接在应用内播放视频并跳转到指定时间点。

## ✨ 主要特性

### 1. 内嵌播放器
- **基于Qt Multimedia**: 使用`QMediaPlayer`和`QVideoWidget`实现
- **无需外部依赖**: 不需要安装VLC、PotPlayer等播放器
- **统一体验**: 所有平台（Windows/macOS/Linux）使用相同的播放器
- **完整控制**: 播放、暂停、停止、进度条、音量、全屏

### 2. 智能视频查找
- **自动查找翻译视频**: 优先播放翻译后的目标视频
- **多种命名模式支持**:
  - `原名_target.mp4`
  - `原名-target.mp4`
  - `原名.target.mp4`
  - `原名_translated.mp4`
  - `原名-translated.mp4`
- **智能回退**: 如果找不到目标视频，自动使用原始视频

### 3. 时间跳转
- **精确跳转**: 点击段落时间链接，自动跳转到对应时间点
- **自动播放**: 跳转后自动开始播放
- **进度显示**: 实时显示当前播放时间和总时长

## 🎮 使用方法

### 方法1: 摘要管理器

1. **打开摘要管理器**
   ```
   主界面 → 点击 "📚" 按钮
   ```

2. **选择视频**
   - 从左侧列表选择一个视频
   - 切换到 "📝 段落详情" 标签页

3. **点击时间链接**
   - 点击任意段落的蓝色时间链接（如 "▶️ 00:00 - 01:30"）
   - 内嵌播放器自动打开并跳转到该时间点

### 方法2: HearSight查看器

1. **打开HearSight**
   ```
   主界面 → 点击 "🎯 HearSight" 按钮
   ```

2. **选择SRT文件**
   - 选择一个SRT字幕文件
   - 等待处理完成

3. **双击段落**
   - 在左侧段落列表中双击任意段落
   - 内嵌播放器自动打开并跳转到该时间点

## ⌨️ 键盘快捷键

| 快捷键 | 功能 |
|--------|------|
| **空格** | 播放/暂停 |
| **F** | 全屏/退出全屏 |
| **ESC** | 退出全屏 |
| **←** | 后退5秒 |
| **→** | 前进5秒 |
| **↑** | 增加音量 |
| **↓** | 减少音量 |

## 🎨 播放器界面

```
┌────────────────────────────────────────────────┐
│                                                │
│                                                │
│              视频显示区域                        │
│                                                │
│                                                │
├────────────────────────────────────────────────┤
│ [▶] [■] 00:12 / 05:30 [━━━━━━━━━━] 🔊 [━━━] [⛶] │
└────────────────────────────────────────────────┘
```

**控制栏说明**:
- **[▶]**: 播放/暂停按钮
- **[■]**: 停止按钮
- **00:12 / 05:30**: 当前时间 / 总时长
- **[━━━━━━━━━━]**: 进度条（可拖动）
- **🔊**: 音量图标
- **[━━━]**: 音量滑块
- **[⛶]**: 全屏按钮

## 🔧 技术实现

### 核心组件

**文件**: `videotrans/ui/video_player.py`

**主要类**: `VideoPlayerDialog`

**关键技术**:
```python
from PySide6.QtMultimedia import QMediaPlayer, QAudioOutput
from PySide6.QtMultimediaWidgets import QVideoWidget

# 创建播放器
self.player = QMediaPlayer()
self.audio_output = QAudioOutput()
self.player.setAudioOutput(self.audio_output)

# 创建视频显示控件
self.video_widget = QVideoWidget()
self.player.setVideoOutput(self.video_widget)

# 加载视频
self.player.setSource(QUrl.fromLocalFile(video_path))

# 跳转到指定时间
self.player.setPosition(int(time_seconds * 1000))

# 开始播放
self.player.play()
```

### 视频查找逻辑

**文件**: `videotrans/ui/summary_manager.py`, `videotrans/ui/hearsight_viewer.py`

**方法**: `find_target_video(source_video_path)`

**查找顺序**:
1. 检查 `原名_target.mp4`
2. 检查 `原名-target.mp4`
3. 检查 `原名.target.mp4`
4. 检查 `原名_translated.mp4`
5. 检查 `原名-translated.mp4`
6. 如果都不存在，使用原始视频

**示例**:
```python
# 原始视频: /path/to/video.mp4
# 查找顺序:
# 1. /path/to/video_target.mp4  ✅ 找到！
# 2. /path/to/video-target.mp4
# 3. /path/to/video.target.mp4
# ...
```

## 📋 支持的视频格式

播放器支持Qt Multimedia支持的所有格式，包括但不限于：

- **MP4** (H.264, H.265)
- **MKV** (Matroska)
- **AVI**
- **MOV** (QuickTime)
- **WebM**
- **FLV**
- **WMV**

**注意**: 具体支持的格式取决于系统安装的编解码器。

## ❓ 常见问题

### Q1: 播放器无法打开？

**可能原因**:
- Qt Multimedia组件未正确安装
- 缺少必要的编解码器

**解决方法**:
```bash
# 确保安装了PySide6的完整版本
pip install PySide6 --upgrade

# 或者单独安装Multimedia组件
pip install PySide6-Addons
```

### Q2: 视频无法播放或显示黑屏？

**可能原因**:
- 视频格式不支持
- 缺少对应的编解码器

**解决方法**:
- 尝试转换视频格式为MP4 (H.264)
- Windows: 安装K-Lite Codec Pack
- macOS: 通常自带所有编解码器
- Linux: 安装`gstreamer`插件

### Q3: 没有找到翻译后的视频？

**检查项**:
1. 翻译后的视频是否与原视频在同一目录
2. 文件名是否符合命名规则（如`video_target.mp4`）
3. 查看控制台输出的日志信息

**日志示例**:
```
✅ 找到目标视频: /path/to/video_target.mp4
⚠️ 未找到目标视频，使用原始视频: /path/to/video.mp4
```

### Q4: 如何自定义目标视频命名规则？

**修改位置**: `videotrans/ui/summary_manager.py` 和 `videotrans/ui/hearsight_viewer.py`

**修改方法**:
```python
def find_target_video(self, source_video_path: str) -> str:
    # 添加自定义命名模式
    target_patterns = [
        f"{video_basename}_target{video_ext}",
        f"{video_basename}_my_custom_suffix{video_ext}",  # 添加这行
        # ...
    ]
```

### Q5: 播放器性能问题？

**优化建议**:
- 使用硬件加速（Qt Multimedia默认启用）
- 降低视频分辨率
- 使用更高效的编码格式（H.264/H.265）

## 🆚 对比：内嵌播放器 vs 外部播放器

| 特性 | 内嵌播放器 | 外部播放器 |
|------|-----------|-----------|
| **安装要求** | ✅ 无需额外安装 | ❌ 需要安装VLC等 |
| **用户体验** | ✅ 统一界面 | ❌ 跳出应用 |
| **时间跳转** | ✅ 精确跳转 | ✅ 支持 |
| **格式支持** | ⚠️ 依赖系统编解码器 | ✅ VLC支持几乎所有格式 |
| **性能** | ✅ 良好 | ✅ 优秀 |
| **跨平台** | ✅ 完全一致 | ⚠️ 不同平台不同播放器 |
| **控制能力** | ✅ 完全控制 | ❌ 有限控制 |

## 🎯 最佳实践

### 1. 视频命名规范

建议使用统一的命名规范：
```
原始视频: video.mp4
翻译视频: video_target.mp4
```

### 2. 视频格式选择

推荐使用MP4 (H.264)格式：
- 兼容性最好
- 文件大小适中
- 播放性能优秀

### 3. 目录结构

建议将原始视频和翻译视频放在同一目录：
```
project/
├── video.mp4           # 原始视频
├── video_target.mp4    # 翻译视频
├── video.srt           # 字幕文件
└── ...
```

## 📊 更新日志

### v2.0.0 (2025-01-03)

**新增功能**:
- ✅ 内嵌视频播放器（基于Qt Multimedia）
- ✅ 智能翻译视频查找
- ✅ 键盘快捷键支持
- ✅ 全屏播放模式
- ✅ 音量控制
- ✅ 进度条拖动

**移除功能**:
- ❌ 外部播放器调用（VLC/PotPlayer/IINA）
- ❌ 跨平台播放器检测

**优化改进**:
- ✅ 简化代码结构
- ✅ 统一用户体验
- ✅ 更好的错误处理

## 🔗 相关文档

- [视频时间跳转功能说明.md](./视频时间跳转功能说明.md) - 旧版外部播放器文档
- [HearSight集成方案.md](./HearSight集成方案.md) - HearSight功能设计文档
- [CHROMADB_查询修复说明.md](./CHROMADB_查询修复说明.md) - ChromaDB查询语法

## 💬 反馈与支持

如果您在使用过程中遇到问题或有改进建议，欢迎反馈！

