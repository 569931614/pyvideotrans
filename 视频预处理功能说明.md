# 视频预处理功能说明

## 功能概述

视频预处理功能允许您在翻译处理前自动裁剪视频的头部和尾部，去除不需要的片段（如片头、片尾）。

## 界面位置

### HTML UI界面（推荐）
在主界面的 **"输入与输出"** 部分，您会看到：

```
☑️ 视频预处理    去掉头部(秒) [0.0]    去掉尾部(秒) [0.0]
```

### Qt原生UI界面
在主界面靠近顶部的位置，"智能摘要"选项下方。

## 使用方法

### 1. 启用视频预处理

勾选 **"视频预处理"** 复选框

### 2. 设置裁剪参数

- **去掉头部(秒)**: 输入要从视频开始裁剪的秒数
  - 范围: 0 - 3600 秒
  - 支持小数: 如 2.5 秒
  - 示例: 输入 `5` 表示去掉前5秒

- **去掉尾部(秒)**: 输入要从视频结尾裁剪的秒数
  - 范围: 0 - 3600 秒
  - 支持小数: 如 3.5 秒
  - 示例: 输入 `10` 表示去掉最后10秒

### 3. 开始处理

正常选择视频并开始翻译任务，预处理会自动在视频分离音视频前执行。

## 使用场景

### 场景1: 去除片头片尾

**问题**: 视频前面有5秒片头，后面有8秒片尾

**解决方案**:
```
☑️ 视频预处理
去掉头部(秒): 5
去掉尾部(秒): 8
```

### 场景2: 只保留视频中间部分

**问题**: 120秒的视频，只需要从10秒到100秒的内容

**解决方案**:
```
☑️ 视频预处理
去掉头部(秒): 10
去掉尾部(秒): 20
```
（120秒 - 10秒开头 - 20秒结尾 = 10-100秒的内容）

### 场景3: 去除开头广告

**问题**: 视频前面有15秒广告

**解决方案**:
```
☑️ 视频预处理
去掉头部(秒): 15
去掉尾部(秒): 0
```

## 技术细节

### 处理流程

1. **预处理阶段**（在视频分离前）
   - 检查是否启用预处理
   - 获取视频总时长
   - 使用FFmpeg进行裁剪
   - 生成临时预处理视频

2. **后续处理**
   - 使用预处理后的视频进行音视频分离
   - 进行语音识别、翻译、配音等操作
   - 最终输出的视频已经是裁剪后的

### FFmpeg命令

实际执行的FFmpeg命令类似：

```bash
ffmpeg -y -i input.mp4 -ss 5.0 -t 85.0 -c:v copy -c:a copy output_preprocessed.mp4
```

参数说明：
- `-ss 5.0`: 从5秒开始
- `-t 85.0`: 持续时长85秒（总时长100秒 - 头5秒 - 尾10秒）
- `-c:v copy -c:a copy`: 直接复制编码（快速处理，无需重新编码）

### 存储位置

预处理后的临时文件存储在：
```
{缓存目录}/preprocessed_video{原视频扩展名}
```

该文件会在处理完成后自动清理。

## 配置持久化

您的预处理设置会自动保存，下次启动程序时会恢复上次的配置：

- 启用状态: `enable_preprocess`
- 头部秒数: `trim_start`
- 尾部秒数: `trim_end`

配置保存在 `params.json` 文件中。

## 注意事项

### 1. 精度

- 裁剪使用 `-c:v copy -c:a copy` 模式，速度快但精度受关键帧影响
- 实际裁剪点可能与设置值有几毫秒的偏差
- 如果需要精确裁剪，可能需要重新编码（会更慢）

### 2. 时长限制

- 最大值: 3600秒（1小时）
- 如果设置的裁剪总和超过视频时长，会导致错误
- 确保: `trim_start + trim_end < 视频总时长`

### 3. 错误处理

如果预处理失败：
- 系统会记录错误日志
- 继续使用原始视频进行后续处理
- 不会中断整个翻译流程

### 4. 性能影响

- 使用编码复制模式，处理速度很快（通常几秒内完成）
- 不会显著增加整体处理时间
- 只会执行一次，后续步骤使用预处理后的视频

## 常见问题

### Q1: 为什么裁剪不精确？

**A**: 视频裁剪受关键帧（I帧）位置影响。`-c:v copy` 模式只能在关键帧位置精确裁剪。如需精确裁剪，可以修改代码去掉 `-c:v copy`，但会显著增加处理时间。

### Q2: 可以裁剪中间部分吗？

**A**: 当前版本只支持裁剪头尾。如需裁剪中间部分，建议先用其他工具处理视频。

### Q3: 预处理失败会影响翻译吗？

**A**: 不会。如果预处理失败，程序会继续使用原始视频进行翻译，不会中断流程。

### Q4: 批量处理时每个视频都会预处理吗？

**A**: 是的。如果启用预处理，批量处理的每个视频都会按照相同的设置进行裁剪。

### Q5: 如何确认预处理是否生效？

**A**: 查看日志输出，会显示类似信息：
```
正在进行视频预处理...
视频预处理完成: 去掉头部5.0秒, 尾部10.0秒
```

## 高级用法

### 代码示例

如果您通过API或代码调用，可以这样设置：

```python
from videotrans.task.trans_create import TransCreate

task = TransCreate(
    cfg={
        'name': '/path/to/video.mp4',
        'enable_preprocess': True,
        'trim_start': 5.0,
        'trim_end': 10.0,
        # ... 其他配置
    }
)

task.prepare()  # 预处理会在这里执行
```

### 自定义预处理逻辑

预处理逻辑在 `videotrans/task/trans_create.py` 的 `_preprocess_trim_video` 方法中：

```python
def _preprocess_trim_video(self, trim_start, trim_end):
    # 您可以修改这里的逻辑来实现自定义预处理
    pass
```

## 相关文件

- **UI定义**: `videotrans/ui/en.py` (Qt界面)
- **HTML UI**: `videotrans/webui/index.html`
- **JavaScript**: `videotrans/webui/app.js`
- **配置加载**: `videotrans/mainwin/_main_win.py`
- **配置保存**: `videotrans/mainwin/_actions.py`
- **处理逻辑**: `videotrans/task/trans_create.py`
- **配置定义**: `videotrans/configure/_config_loader.py`

## 更新日志

### v1.0 (2025-10-11)
- ✅ 初始版本发布
- ✅ 支持头尾裁剪
- ✅ Qt和HTML UI支持
- ✅ 配置持久化
- ✅ 错误处理

## 反馈与建议

如果您有任何问题或建议，请：
1. 查看日志文件获取详细错误信息
2. 在GitHub仓库提交Issue
3. 提供视频信息和配置参数以便调试
